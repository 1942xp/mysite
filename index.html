<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Birlikte ƒ∞zleme | Pro V5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #020617; color: white; margin: 0; height: 100vh; overflow: hidden; }
        .glass { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); }
        #video-section { height: 35vh; background: #000; position: relative; overflow: hidden; }
        #chat-section { height: 65vh; display: flex; flex-direction: column; position: relative; }
        
        /* Video Toast */
        .video-toast { background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); padding: 5px 10px; border-radius: 8px; margin-bottom: 5px; animation: fadeInOut 4s forwards; border-right: 2px solid #3b82f6; }
        @keyframes fadeInOut { 0% { opacity: 0; transform: translateX(20px); } 10% { opacity: 1; transform: translateX(0); } 100% { opacity: 0; } }

        /* Emoji Paneli */
        #emoji-drawer { display: none; position: absolute; top: 45px; left: 10px; z-index: 200; grid-template-cols: repeat(4, 1fr); gap: 8px; padding: 10px; border-radius: 15px; }
        
        /* Mesaj Kutusu Fix */
        .input-area { background: #0f172a; border-top: 1px solid rgba(255,255,255,0.1); padding-bottom: 25px; }

        .emoji-fly { position: fixed; bottom: 50%; pointer-events: none; animation: flyUp 2s forwards; font-size: 3rem; z-index: 300; }
        @keyframes flyUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-300px); } }
    </style>
</head>
<body>

<div id="login-screen" class="fixed inset-0 z-[500] bg-slate-950 flex items-center justify-center p-4">
    <div class="glass max-w-sm w-full p-6 rounded-[2rem] text-center">
        <h2 class="text-xl font-bold mb-4 text-blue-400">Karakterini Se√ß</h2>
        <div class="grid grid-cols-5 gap-2 mb-4 max-h-40 overflow-y-auto p-2 bg-black/20 rounded-xl" id="avatar-list"></div>
        <input id="username" type="text" placeholder="ƒ∞sminiz" class="w-full bg-slate-900 p-3 rounded-xl mb-2 outline-none border border-white/5">
        <input id="room-pass" type="password" placeholder="Oda ≈ûifresi" class="w-full bg-slate-900 p-3 rounded-xl mb-4 outline-none">
        <button onclick="checkEntry()" class="w-full bg-blue-600 py-3 rounded-xl font-bold">Gƒ∞Rƒ∞≈û YAP</button>
    </div>
</div>

<div id="app-screen" class="hidden flex flex-col h-screen">
    
    <div id="video-section">
        <div id="video-toast-container" class="absolute top-2 right-2 z-50 pointer-events-none"></div>
        
        <button onclick="toggleEmojiDrawer()" class="absolute left-3 top-3 z-[210] bg-black/50 w-10 h-10 rounded-full flex items-center justify-center border border-white/20">üòä</button>
        <div id="emoji-drawer" class="glass grid grid-cols-4">
            </div>

        <video id="main-video" class="w-full h-full" playsinline webkit-playsinline>
            <source src="video.mp4" type="video/mp4">
        </video>
        
        <div id="video-touch-layer" onclick="handleVideoTouch()" class="absolute inset-0 z-40"></div>
    </div>

    <div id="chat-section">
        <div class="p-3 border-b border-white/5 flex justify-between items-center bg-slate-900">
            <div class="flex items-center gap-2 text-xs">
                <span id="my-avatar" class="text-lg"></span>
                <span id="display-name" class="font-bold opacity-70"></span>
            </div>
            <div class="flex items-center gap-2">
                <div id="admin-seek-controls" class="hidden flex gap-2">
                    <button onclick="seek(-15)" class="bg-slate-800 px-3 py-1 rounded-lg text-xs font-bold text-blue-400">-15s</button>
                    <button onclick="seek(15)" class="bg-slate-800 px-3 py-1 rounded-lg text-xs font-bold text-blue-400">+15s</button>
                </div>
                <div id="admin-badge" class="hidden text-[10px] bg-yellow-500/20 text-yellow-500 px-2 py-1 rounded-md font-bold border border-yellow-500/20 uppercase">Y√∂netici</div>
            </div>
        </div>

        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
        
        <div class="input-area px-4 py-3">
            <div class="flex gap-2 mb-2">
                <input id="chat-input" type="text" placeholder="Mesaj yaz..." class="flex-1 bg-white/5 p-3 rounded-2xl outline-none border border-white/10 text-sm">
                <button onclick="sendMessage()" class="bg-blue-600 px-5 rounded-2xl font-bold text-sm">G√ñNDER</button>
            </div>
        </div>
    </div>

    <button id="settings-btn" onclick="showAdminModal()" class="fixed bottom-32 right-4 w-10 h-10 bg-slate-800/80 rounded-full z-[100] border border-white/10">‚öôÔ∏è</button>
</div>

<div id="admin-modal" class="fixed inset-0 bg-black/95 hidden flex items-center justify-center z-[600] p-6">
    <div class="glass p-6 rounded-3xl max-w-sm w-full">
        <div id="admin-login-view">
            <h3 class="text-center font-bold mb-4 text-yellow-500">ADMIN DOƒûRULAMA</h3>
            <input id="admin-pass-input" type="password" placeholder="≈ûifre" class="w-full bg-slate-900 p-3 rounded-xl mb-4 outline-none border border-yellow-500/10">
            <button onclick="tryAdmin()" class="w-full bg-yellow-600 text-black font-bold py-3 rounded-xl">YETKƒ∞ AL</button>
            <button onclick="closeAdminModal()" class="w-full text-xs text-gray-500 mt-4 text-center">Kapat</button>
        </div>
        <div id="admin-panel-view" class="hidden space-y-4">
            <button onclick="resetChat()" class="w-full bg-red-600/20 text-red-500 p-2 rounded-lg font-bold text-xs">SOHBETƒ∞ TEMƒ∞ZLE</button>
            <div id="user-kick-list" class="max-h-40 overflow-y-auto"></div>
            <button onclick="closeAdminModal()" class="w-full bg-white/5 p-2 rounded-lg text-xs">PANELƒ∞ KAPAT</button>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, get, set, onValue, push, remove } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDBechvUwDzQ5gD8cdiDN_qSObt7RFKKUg",
  authDomain: "birlikte-izleme.firebaseapp.com",
  databaseURL: "https://birlikte-izleme-default-rtdb.firebaseio.com",
  projectId: "birlikte-izleme",
  storageBucket: "birlikte-izleme.firebasestorage.app",
  messagingSenderId: "488401543618",
  appId: "1:488401543618:web:e758697faebdeabb64765b"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let myUser = { id: Math.random().toString(36).substr(2, 9), name: "", avatar: "üë§", role: "user" };
const video = document.getElementById("main-video");
const avatars = ["üê±", "üê∂", "ü¶ä", "ü¶Å", "üê∏", "ü§ñ", "ü¶Ñ", "üêß", "üêº", "üê®", "üêô", "üëª", "üêµ", "üê•", "üêù", "ü¶ñ", "ü•®", "üçï", "üéà", "üçî", "üç¶", "üöÄ", "üé∏", "üéÆ", "üëë", "üßø", "üçÄ", "üî•", "üíé", "üåà"];
const emojis = ['üòò','üòÇ','üî•','‚ù§Ô∏è','üòÆ','üëè','üíÄ','üíØ','üéâ','üëÄ','‚ú®','üôå'];

// Karakter Hazƒ±rla
const avList = document.getElementById("avatar-list");
avatars.forEach(a => {
    const d = document.createElement("div");
    d.className = "text-2xl p-2 cursor-pointer rounded-xl hover:bg-white/10";
    d.textContent = a;
    d.onclick = () => {
        document.querySelectorAll("#avatar-list div").forEach(el => el.classList.remove('bg-blue-600'));
        d.classList.add('bg-blue-600');
        myUser.avatar = a;
    };
    avList.appendChild(d);
});

// Emoji Hazƒ±rla
const emDrawer = document.getElementById("emoji-drawer");
emojis.forEach(e => {
    const b = document.createElement("button");
    b.className = "text-xl p-2 hover:bg-white/10 rounded-lg";
    b.textContent = e;
    b.onclick = () => { sendEmoji(e); toggleEmojiDrawer(); };
    emDrawer.appendChild(b);
});

window.toggleEmojiDrawer = () => {
    const d = document.getElementById("emoji-drawer");
    d.style.display = (d.style.display === 'grid') ? 'none' : 'grid';
};

// Vƒ∞DEO TAM EKRAN VE YAN YATIRMA
window.handleVideoTouch = async () => {
    if (!document.fullscreenElement) {
        try {
            await video.requestFullscreen();
            if (screen.orientation && screen.orientation.lock) {
                await screen.orientation.lock("landscape").catch(() => {});
            }
        } catch (e) {}
    } else {
        document.exitFullscreen();
    }
};

window.checkEntry = async () => {
    const pass = document.getElementById("room-pass").value;
    const name = document.getElementById("username").value;
    const snap = await get(ref(db, "room1"));
    if(pass === String(snap.val().enterPassword)) {
        myUser.name = name;
        document.getElementById("login-screen").classList.add("hidden");
        document.getElementById("app-screen").classList.remove("hidden");
        document.getElementById("my-avatar").textContent = myUser.avatar;
        document.getElementById("display-name").textContent = name;
        set(ref(db, "room1/users/" + myUser.id), { name: name, avatar: myUser.avatar });
        startApp();
    } else { alert("≈ûifre Hatalƒ±!"); }
};

function startApp() {
    let firstLoad = true;
    onValue(ref(db, "room1/chat"), snap => {
        const box = document.getElementById("chat-messages");
        box.innerHTML = "";
        const data = snap.val() || {};
        Object.values(data).forEach(d => {
            box.innerHTML += `<div class="flex gap-2"><span>${d.avatar}</span><div><p class="text-[10px] opacity-50 font-bold">${d.user}</p><p class="text-sm">${d.text}</p></div></div>`;
        });
        box.scrollTop = box.scrollHeight;
        
        if(!firstLoad) {
            const last = Object.values(data).pop();
            if(last && last.user !== myUser.name) showVideoToast(last.user, last.text);
        }
        firstLoad = false;
    });

    onValue(ref(db, "room1/video"), snap => {
        if(myUser.role === 'admin') return;
        const s = snap.val();
        if(Math.abs(video.currentTime - s.time) > 2.5) video.currentTime = s.time;
        s.playing ? video.play().catch(() => {}) : video.pause();
    });

    onValue(ref(db, "room1/emojis"), snap => { if(snap.exists()) triggerEmoji(snap.val().icon); });
    onValue(ref(db, "room1/users/" + myUser.id), snap => { if(!snap.exists()) location.reload(); });
    onValue(ref(db, "room1/users"), snap => {
        const list = document.getElementById("user-kick-list");
        list.innerHTML = "";
        snap.forEach(u => {
            if(u.key !== myUser.id) list.innerHTML += `<div class="flex justify-between items-center bg-white/5 p-2 rounded-lg mb-1 text-xs"><span>${u.val().name}</span><button onclick="kickUser('${u.key}')" class="text-red-500 font-bold">AT</button></div>`;
        });
    });
}

function showVideoToast(user, text) {
    const container = document.getElementById("video-toast-container");
    const t = document.createElement("div");
    t.className = "video-toast";
    t.innerHTML = `<p class="text-[8px] font-bold text-blue-400">${user}</p><p class="text-[10px] truncate max-w-[120px]">${text}</p>`;
    container.appendChild(t);
    setTimeout(() => t.remove(), 4000);
}

window.tryAdmin = async () => {
    const pass = document.getElementById("admin-pass-input").value;
    const snap = await get(ref(db, "room1/adminPassword"));
    if(pass === String(snap.val())) {
        myUser.role = "admin";
        document.getElementById("admin-login-view").classList.add("hidden");
        document.getElementById("admin-panel-view").classList.remove("hidden");
        document.getElementById("admin-seek-controls").classList.remove("hidden");
        document.getElementById("admin-badge").classList.remove("hidden");
        document.getElementById("settings-btn").textContent = "üèÜ";
        // Admin videoyu kontrol edebilir hale gelir
        document.getElementById("video-touch-layer").style.display = "none";
        video.controls = true;
    }
};

window.seek = (s) => {
    video.currentTime += s;
    set(ref(db, "room1/video"), { playing: !video.paused, time: video.currentTime });
};

window.sendMessage = () => {
    const inp = document.getElementById("chat-input");
    if(!inp.value) return;
    push(ref(db, "room1/chat"), { user: myUser.name, avatar: myUser.avatar, text: inp.value });
    inp.value = "";
};

window.sendEmoji = (icon) => set(ref(db, "room1/emojis"), { icon: icon, t: Date.now() });

function triggerEmoji(icon) {
    const el = document.createElement("div");
    el.className = "emoji-fly";
    el.textContent = icon;
    el.style.left = Math.random() * 60 + 20 + "%";
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 2000);
}

window.showAdminModal = () => document.getElementById("admin-modal").classList.toggle("hidden");
window.closeAdminModal = () => document.getElementById("admin-modal").classList.add("hidden");
window.resetChat = () => remove(ref(db, "room1/chat"));
window.kickUser = (uid) => remove(ref(db, "room1/users/" + uid));
</script>
</body>
</html>
