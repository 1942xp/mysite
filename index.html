<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Birlikte ƒ∞zleme</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  margin: 0;
  background: #111;
  color: #fff;
  font-family: Arial, sans-serif;
}

#login {
  height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

input, button {
  padding: 12px;
  margin: 6px;
  font-size: 16px;
  width: 220px;
}

#error {
  color: red;
  margin-top: 10px;
}

#app {
  display: none;
}

video {
  width: 100%;
  max-height: 60vh;
  background: black;
}

#chat {
  height: 25vh;
  overflow-y: auto;
  border-top: 1px solid #333;
  padding: 10px;
}

#chat div {
  margin-bottom: 5px;
}
</style>
</head>

<body>

<!-- Gƒ∞Rƒ∞≈û -->
<div id="login">
  <h2>üîê Odaya Gir</h2>
  <input id="enterPass" placeholder="Oda ≈ûifresi">
  <input id="adminPass" placeholder="Y√∂netici ≈ûifresi (opsiyonel)">
  <button onclick="enterRoom()">Giri≈ü Yap</button>
  <div id="error"></div>
</div>

<!-- UYGULAMA -->
<div id="app">
  <video id="video" controls>
    <source src="video.mp4" type="video/mp4">
  </video>

  <div id="chat"></div>

  <div style="display:flex;">
    <input id="msg" placeholder="Mesaj yaz">
    <button onclick="sendMsg()">G√∂nder</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, get, set, onValue, push } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDBechvUwDzQ5gD8cdiDN_qSObt7RFKKUg",
  authDomain: "birlikte-izleme.firebaseapp.com",
  databaseURL: "https://birlikte-izleme-default-rtdb.firebaseio.com",
  projectId: "birlikte-izleme",
  storageBucket: "birlikte-izleme.firebasestorage.app",
  messagingSenderId: "488401543618",
  appId: "1:488401543618:web:e758697faebdeabb64765b"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const roomRef = ref(db, "room1");
const videoRef = ref(db, "room1/video");
const chatRef = ref(db, "room1/chat");

const video = document.getElementById("video");
let isAdmin = false;

window.enterRoom = async () => {
  const enter = enterPass.value;
  const admin = adminPass.value;
  const error = document.getElementById("error");

  const snap = await get(roomRef);
  const data = snap.val();

  if (enter !== String(data.enterPassword)) {
    error.textContent = "‚ùå Oda ≈üifresi yanlƒ±≈ü";
    return;
  }

  if (admin === String(data.adminPassword)) {
    isAdmin = true;
  }

  document.getElementById("login").style.display = "none";
  document.getElementById("app").style.display = "block";

  if (!isAdmin) {
    video.controls = false;
  }
};

// üîÅ Video senkron
video.addEventListener("play", () => {
  if (isAdmin) set(videoRef, { playing: true, time: video.currentTime });
});

video.addEventListener("pause", () => {
  if (isAdmin) set(videoRef, { playing: false, time: video.currentTime });
});

video.addEventListener("seeked", () => {
  if (isAdmin) set(videoRef, { playing: !video.paused, time: video.currentTime });
});

onValue(videoRef, snap => {
  if (!snap.exists() || isAdmin) return;
  const s = snap.val();
  video.currentTime = s.time;
  s.playing ? video.play() : video.pause();
});

// üí¨ Chat
window.sendMsg = () => {
  if (!msg.value) return;
  push(chatRef, { text: msg.value });
  msg.value = "";
};

onValue(chatRef, snap => {
  chat.innerHTML = "";
  snap.forEach(m => {
    const d = document.createElement("div");
    d.textContent = m.val().text;
    chat.appendChild(d);
  });
});
</script>

</body>
</html>
