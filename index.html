<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Birlikte Ä°zleme | Pro V4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #020617; color: white; margin: 0; height: 100vh; overflow: hidden; }
        .glass { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        #video-section { height: 35vh; background: #000; position: relative; z-index: 10; }
        #chat-section { height: 65vh; display: flex; flex-direction: column; }
        
        /* Video ÃœstÃ¼ Silik Mesaj Paneli */
        #video-toast-container {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 180px;
            z-index: 100;
            pointer-events: none;
        }
        .video-toast {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            border-left: 3px solid rgba(59, 130, 246, 0.5);
            padding: 6px 10px;
            border-radius: 8px;
            margin-bottom: 5px;
            animation: fadeInOut 4s forwards;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(20px); }
            10% { opacity: 1; transform: translateX(0); }
            80% { opacity: 0.8; }
            100% { opacity: 0; transform: translateY(-10px); }
        }

        .emoji-fly { position: fixed; bottom: 50%; pointer-events: none; animation: flyUp 2s ease-out forwards; font-size: 3rem; z-index: 100; }
        @keyframes flyUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-400px) scale(2); opacity: 0; } }
        .seek-btn { background: #1e293b; padding: 6px 16px; border-radius: 10px; font-size: 13px; font-weight: bold; border: 1px solid #334155; }
        .chat-input-container { padding-bottom: env(safe-area-inset-bottom, 25px); background: #020617; }
    </style>
</head>
<body>

<div id="login-screen" class="fixed inset-0 z-[500] bg-slate-950 flex items-center justify-center p-4">
    <div class="glass max-w-sm w-full p-6 rounded-[2rem] text-center">
        <h2 class="text-xl font-bold mb-4 text-blue-400">Karakterini SeÃ§ & Gir</h2>
        <div class="grid grid-cols-5 gap-2 mb-4 max-h-48 overflow-y-auto p-2 bg-black/20 rounded-xl" id="avatar-list"></div>
        <input id="username" type="text" placeholder="AdÄ±nÄ±z" class="w-full bg-slate-900 p-3 rounded-xl mb-2 outline-none border border-white/5 text-sm">
        <input id="room-pass" type="password" placeholder="Oda Åifresi" class="w-full bg-slate-900 p-3 rounded-xl mb-4 outline-none border border-white/5 text-sm">
        <button onclick="checkEntry()" class="w-full bg-blue-600 py-3 rounded-xl font-bold">BAÄLAN</button>
    </div>
</div>

<div id="app-screen" class="hidden flex flex-col h-screen">
    
    <div id="video-section">
        <div id="video-toast-container"></div>

        <video id="main-video" class="w-full h-full" playsinline controls webkit-playsinline allowfullscreen>
            <source src="video.mp4" type="video/mp4">
        </video>

        <div id="emoji-menu" class="absolute left-2 top-2 flex flex-wrap gap-2 z-50 max-w-[140px]">
            <button onclick="sendEmoji('ğŸ˜˜')" class="text-xl bg-black/40 p-1.5 rounded-lg">ğŸ˜˜</button>
            <button onclick="sendEmoji('ğŸ˜‚')" class="text-xl bg-black/40 p-1.5 rounded-lg">ğŸ˜‚</button>
            <button onclick="sendEmoji('ğŸ”¥')" class="text-xl bg-black/40 p-1.5 rounded-lg">ğŸ”¥</button>
            <button onclick="sendEmoji('â¤ï¸')" class="text-xl bg-black/40 p-1.5 rounded-lg">â¤ï¸</button>
            <button onclick="sendEmoji('ğŸ˜®')" class="text-xl bg-black/40 p-1.5 rounded-lg">ğŸ˜®</button>
            <button onclick="sendEmoji('ğŸ‘')" class="text-xl bg-black/40 p-1.5 rounded-lg">ğŸ‘</button>
            <button onclick="sendEmoji('ğŸ’€')" class="text-xl bg-black/40 p-1.5 rounded-lg">ğŸ’€</button>
            <button onclick="sendEmoji('ğŸ’¯')" class="text-xl bg-black/40 p-1.5 rounded-lg">ğŸ’¯</button>
        </div>
    </div>

    <div id="chat-section">
        <div class="p-3 border-b border-white/5 flex justify-between items-center bg-slate-900/50">
            <div class="flex items-center gap-2">
                <span id="my-avatar" class="text-xl"></span>
                <span class="font-bold text-xs" id="display-name">...</span>
            </div>
            <div class="flex items-center gap-2">
                <div id="admin-seek-controls" class="hidden flex gap-2">
                    <button onclick="seek(-15)" class="seek-btn text-blue-400">-15s</button>
                    <button onclick="seek(15)" class="seek-btn text-blue-400">+15s</button>
                </div>
                <div id="admin-badge" class="hidden text-[10px] bg-yellow-500/20 text-yellow-500 px-3 py-1 rounded-full font-bold border border-yellow-500/30">YÃ–NETÄ°CÄ°</div>
            </div>
        </div>

        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-950/20"></div>
        
        <div class="chat-input-container p-4">
            <div class="flex gap-2">
                <input id="chat-input" type="text" placeholder="Mesaj yaz..." class="flex-1 bg-white/5 p-3 rounded-xl outline-none border border-white/5 focus:border-blue-500 text-sm">
                <button onclick="sendMessage()" class="bg-blue-600 px-6 rounded-xl font-bold">GÃ–NDER</button>
            </div>
        </div>
    </div>

    <button id="settings-btn" onclick="showAdminModal()" class="fixed bottom-28 right-4 w-10 h-10 bg-slate-800 rounded-full flex items-center justify-center z-[100] opacity-60">âš™ï¸</button>
</div>

<div id="admin-modal" class="fixed inset-0 bg-black/95 hidden flex items-center justify-center z-[600] p-6">
    <div class="glass p-6 rounded-3xl max-w-sm w-full">
        <div id="admin-login-view">
            <h3 class="text-center font-bold mb-4 text-yellow-500">YÃ–NETÄ°CÄ° GÄ°RÄ°ÅÄ°</h3>
            <input id="admin-pass-input" type="password" placeholder="Admin Åifresi" class="w-full bg-slate-900 p-3 rounded-xl mb-4 outline-none border border-yellow-500/20">
            <button onclick="tryAdmin()" class="w-full bg-yellow-600 text-black font-bold py-3 rounded-xl">YETKÄ° AL</button>
            <button onclick="closeAdminModal()" class="w-full text-xs text-gray-500 mt-4 text-center">Kapat</button>
        </div>
        <div id="admin-panel-view" class="hidden space-y-4 text-center">
            <h3 class="text-yellow-500 font-bold italic">YÃ–NETÄ°M PANELÄ°</h3>
            <button onclick="resetChat()" class="w-full bg-red-600/20 text-red-500 p-2 rounded-lg font-bold">SOHBETÄ° TEMÄ°ZLE</button>
            <div id="user-kick-list" class="max-h-40 overflow-y-auto space-y-1"></div>
            <button onclick="closeAdminModal()" class="w-full bg-white/5 p-2 rounded-lg text-xs font-bold">PANELÄ° KAPAT</button>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, get, set, onValue, push, remove, limitToLast, query } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDBechvUwDzQ5gD8cdiDN_qSObt7RFKKUg",
  authDomain: "birlikte-izleme.firebaseapp.com",
  databaseURL: "https://birlikte-izleme-default-rtdb.firebaseio.com",
  projectId: "birlikte-izleme",
  storageBucket: "birlikte-izleme.firebasestorage.app",
  messagingSenderId: "488401543618",
  appId: "1:488401543618:web:e758697faebdeabb64765b"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let myUser = { id: Math.random().toString(36).substr(2, 9), name: "", avatar: "ğŸ‘¤", role: "user" };
const video = document.getElementById("main-video");
const avatars = ["ğŸ±", "ğŸ¶", "ğŸ¦Š", "ğŸ¦", "ğŸ¸", "ğŸ¤–", "ğŸ¦„", "ğŸ§", "ğŸ¼", "ğŸ¨", "ğŸ™", "ğŸ‘»", "ğŸµ", "ğŸ¥", "ğŸ", "ğŸ¦–", "ğŸ¥¨", "ğŸ•", "ğŸˆ", "ğŸ”", "ğŸ¦", "ğŸš€", "ğŸ¸", "ğŸ®", "ğŸ‘‘", "ğŸ§¿", "ğŸ€", "ğŸ”¥", "ğŸ’", "ğŸŒˆ"];

const avList = document.getElementById("avatar-list");
avatars.forEach(a => {
    const d = document.createElement("div");
    d.className = "text-2xl p-2 cursor-pointer rounded-xl hover:bg-white/10";
    d.textContent = a;
    d.onclick = () => {
        document.querySelectorAll("#avatar-list div").forEach(el => el.classList.remove('bg-blue-600'));
        d.classList.add('bg-blue-600');
        myUser.avatar = a;
    };
    avList.appendChild(d);
});

window.checkEntry = async () => {
    const pass = document.getElementById("room-pass").value;
    const name = document.getElementById("username").value;
    const snap = await get(ref(db, "room1"));
    if(pass === String(snap.val().enterPassword)) {
        myUser.name = name;
        document.getElementById("login-screen").classList.add("hidden");
        document.getElementById("app-screen").classList.remove("hidden");
        document.getElementById("my-avatar").textContent = myUser.avatar;
        document.getElementById("display-name").textContent = name;
        set(ref(db, "room1/users/" + myUser.id), { name: name, avatar: myUser.avatar });
        startApp();
    } else { alert("Åifre HatalÄ±!"); }
};

function startApp() {
    // Mesaj Takibi ve Video Bildirimi
    let isFirstLoad = true;
    const chatRef = query(ref(db, "room1/chat"), limitToLast(1));
    onValue(ref(db, "room1/chat"), snap => {
        const box = document.getElementById("chat-messages");
        box.innerHTML = "";
        snap.forEach(m => {
            const d = m.val();
            box.innerHTML += `<div class="flex gap-2"><span>${d.avatar}</span><div><p class="text-[10px] opacity-50 font-bold">${d.user}</p><p class="text-sm">${d.text}</p></div></div>`;
        });
        box.scrollTop = box.scrollHeight;

        // Son mesajÄ± video Ã¼stÃ¼nde gÃ¶ster
        if(!isFirstLoad) {
            const lastMsg = Object.values(snap.val() || {}).pop();
            if(lastMsg && lastMsg.user !== myUser.name) {
                showVideoToast(lastMsg.user, lastMsg.text);
            }
        }
        isFirstLoad = false;
    });

    onValue(ref(db, "room1/video"), snap => {
        if(myUser.role === 'admin') return;
        const s = snap.val();
        if(Math.abs(video.currentTime - s.time) > 2.5) video.currentTime = s.time;
        s.playing ? video.play().catch(() => {}) : video.pause();
    });

    onValue(ref(db, "room1/emojis"), snap => { if(snap.exists()) triggerEmoji(snap.val().icon); });
    onValue(ref(db, "room1/users/" + myUser.id), snap => { if(!snap.exists()) location.reload(); });
    onValue(ref(db, "room1/users"), snap => {
        const list = document.getElementById("user-kick-list");
        list.innerHTML = "";
        snap.forEach(u => {
            if(u.key !== myUser.id) list.innerHTML += `<div class="flex justify-between items-center text-xs p-2 bg-white/5 rounded-lg mb-1"><span>${u.val().avatar} ${u.val().name}</span><button onclick="kickUser('${u.key}')" class="text-red-500 font-bold">AT</button></div>`;
        });
    });
}

function showVideoToast(user, text) {
    const container = document.getElementById("video-toast-container");
    const toast = document.createElement("div");
    toast.className = "video-toast";
    toast.innerHTML = `<p class="text-[9px] font-bold text-blue-300">${user}</p><p class="text-[11px] truncate">${text}</p>`;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
}

window.tryAdmin = async () => {
    const pass = document.getElementById("admin-pass-input").value;
    const snap = await get(ref(db, "room1/adminPassword"));
    if(pass === String(snap.val())) {
        myUser.role = "admin";
        document.getElementById("admin-login-view").classList.add("hidden");
        document.getElementById("admin-panel-view").classList.remove("hidden");
        document.getElementById("admin-seek-controls").classList.remove("hidden");
        document.getElementById("admin-badge").classList.remove("hidden");
        document.getElementById("settings-btn").textContent = "ğŸ†";
    }
};

window.seek = (s) => {
    video.currentTime += s;
    set(ref(db, "room1/video"), { playing: !video.paused, time: video.currentTime });
};

window.sendMessage = () => {
    const inp = document.getElementById("chat-input");
    if(!inp.value) return;
    push(ref(db, "room1/chat"), { user: myUser.name, avatar: myUser.avatar, text: inp.value });
    inp.value = "";
};

window.sendEmoji = (icon) => set(ref(db, "room1/emojis"), { icon: icon, t: Date.now() });

function triggerEmoji(icon) {
    const el = document.createElement("div");
    el.className = "emoji-fly";
    el.textContent = icon;
    el.style.left = Math.random() * 60 + 20 + "%";
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 2000);
}

window.showAdminModal = () => document.getElementById("admin-modal").classList.toggle("hidden");
window.closeAdminModal = () => document.getElementById("admin-modal").classList.add("hidden");
window.resetChat = () => remove(ref(db, "room1/chat"));
window.kickUser = (uid) => remove(ref(db, "room1/users/" + uid));
</script>
</body>
</html>
